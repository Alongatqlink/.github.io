<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VIP Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .form-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>VIP Registration</h1>
    <form onsubmit="handleSubmit(event)">
      <div class="form-group">
        <label for="dealerCode">Dealer Code (required)</label>
        <input type="text" class="form-control" id="dealerCode" required>
      </div>
      <div class="form-group">
        <label for="model">Model</label>
        <input type="text" class="form-control" id="model" placeholder="e.g. ABC-123">
      </div>
      <div class="form-group">
        <label for="productSerial">Product Serial (required)</label>
        <input type="text" class="form-control" id="productSerial" required>
      </div>
      <div class="form-group">
        <label for="consumerName">Consumer Name</label>
        <input type="text" class="form-control" id="consumerName">
      </div>
      <div class="form-group">
        <label for="phoneNumber">Phone / WhatsApp Number</label>
        <input type="text" class="form-control" id="phoneNumber">
      </div>
      <div class="form-group">
        <label for="purchaseDate">Purchase Date</label>
        <input type="date" class="form-control" id="purchaseDate">
      </div>
      <div class="form-group">
        <label for="city">City</label>
        <input type="text" class="form-control" id="city">
      </div>
      <div class="form-group">
        <label for="state">State</label>
        <input type="text" class="form-control" id="state">
      </div>
      <button type="submit" class="btn btn-primary">Submit Registration</button>
    </form>
    <div id="result" class="mt-3 text-danger"></div>
  </div>

  <script>
    // 1. 前端驗證非法字元 (簡單示範)
    //    你可改用更嚴謹的 Regex or rules
    function isInvalidInput(value) {
      // 不允許空白開頭、只允許英數與常見符號 (可再調整)
      // 這只是示範, 你可以改 stricter or simpler
      const pattern = /^[a-zA-Z0-9\s\-\_,.()\/]*$/;
      return !pattern.test(value);
    }

    function handleSubmit(e) {
      e.preventDefault();

      // 2. 取得表單值
      const dealerCode    = document.getElementById('dealerCode').value.trim();
      const model         = document.getElementById('model').value.trim();
      const productSerial = document.getElementById('productSerial').value.trim();
      const consumerName  = document.getElementById('consumerName').value.trim();
      const phoneNumber   = document.getElementById('phoneNumber').value.trim();
      const purchaseDate  = document.getElementById('purchaseDate').value.trim();
      const city          = document.getElementById('city').value.trim();
      const state         = document.getElementById('state').value.trim();

      // 3. 前端檢查：必填 & 不可非法字元
      if (!dealerCode || !productSerial) {
        document.getElementById('result').innerText = "Dealer Code and Product Serial are required.";
        return;
      }
      // 簡單示範: 檢查幾個主要欄位
      if (isInvalidInput(dealerCode) || isInvalidInput(productSerial) ||
          isInvalidInput(model)      || isInvalidInput(consumerName)   ||
          isInvalidInput(phoneNumber)|| isInvalidInput(city)           ||
          isInvalidInput(state)) {
        document.getElementById('result').innerText = "Invalid characters detected.";
        return;
      }

      // 4. 用表單格式送出 (URLSearchParams) -> 不觸發 CORS 預檢
      const formData = new URLSearchParams();
      formData.append('dealerCode', dealerCode);
      formData.append('model', model);
      formData.append('productSerial', productSerial);
      formData.append('consumerName', consumerName);
      formData.append('phoneNumber', phoneNumber);
      formData.append('purchaseDate', purchaseDate);
      formData.append('city', city);
      formData.append('state', state);

      // 5. 呼叫後端 Apps Script
      fetch('https://script.google.com/macros/s/AKfycbzECGqAyJ7Gf88Tgw1DpG4C9mW1qFQCq0OtPmmx1RGS-_esSBE8WOmwed3-Fc5kDdPH/exec', {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(text => {
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          document.getElementById('result').innerText = "Response parse error.";
          return;
        }
        if (data.result === "success") {
          document.getElementById('result').innerText = "Registration Successful!";
          document.getElementById('result').classList.remove('text-danger');
          document.getElementById('result').classList.add('text-success');
        } else {
          // 顯示後端錯誤訊息 (例如序號重複)
          document.getElementById('result').innerText = "Failed: " + (data.error || "Unknown Error");
          document.getElementById('result').classList.remove('text-success');
          document.getElementById('result').classList.add('text-danger');
        }
      })
      .catch(error => {
        console.error(error);
        document.getElementById('result').innerText = "Request failed. Please try again.";
      });
    }
  </script>
</body>
</html>
